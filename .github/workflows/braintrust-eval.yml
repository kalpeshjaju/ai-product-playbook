# Braintrust CI/CD Eval — Merge-blocking prompt evaluation
#
# WHY: Playbook §9 — prevents prompt regressions from merging.
#      Runs statistical significance tests against baseline scores.
# HOW: Triggers on PRs touching shared-llm or prompt files.
#      Guarded by BRAINTRUST_ENABLED repo variable — skips entirely when not set.
#
# AUTHOR: Claude Opus 4.6
# LAST UPDATED: 2026-02-28

name: Braintrust Eval

on:
  pull_request:
    paths:
      - 'packages/shared-llm/**'
      - '**/prompts/**'
      - 'services/dspy/**'

jobs:
  eval:
    name: Prompt Regression Check
    runs-on: ubuntu-latest
    if: vars.BRAINTRUST_ENABLED == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Braintrust SDK
        run: npm install braintrust

      - name: Build shared-llm
        run: npx turbo build --filter=@playbook/shared-llm

      # NOTE: To make this merge-blocking, add "Prompt Regression Check" as a
      # required status check in repo Settings → Branches → main → Protection rules.
      - name: Run Braintrust evaluation
        env:
          BRAINTRUST_API_KEY: ${{ secrets.BRAINTRUST_API_KEY }}
          LITELLM_PROXY_URL: ${{ secrets.LITELLM_PROXY_URL }}
          LITELLM_API_KEY: ${{ secrets.LITELLM_API_KEY }}
        run: npx tsx packages/shared-llm/braintrust-eval.ts

      - name: Comment PR with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const resultPath = 'packages/shared-llm/braintrust-results.json';
            if (!fs.existsSync(resultPath)) {
              console.log('No results file found — eval may have been skipped');
              return;
            }
            const results = JSON.parse(fs.readFileSync(resultPath, 'utf8'));
            const body = [
              '## Braintrust Eval Results',
              '',
              `**Status**: ${results.passed ? '✅ Passed' : '❌ Failed'}`,
              `**Score**: ${results.score?.toFixed(3) ?? 'N/A'}`,
              `**Baseline**: ${results.baseline?.toFixed(3) ?? 'N/A'}`,
              `**Experiments**: ${results.experimentCount ?? 0}`,
              '',
              '> Auto-generated by Braintrust CI/CD eval (§9)',
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
