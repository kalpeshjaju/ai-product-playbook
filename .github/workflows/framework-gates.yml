##
# FILE PURPOSE: Framework-specific CI gates (separate from main CI)
#
# WHY: Pillars 2, 5, 6 of the LLM Coding Framework need CI enforcement
#      beyond type-check/lint/test. Impact graph, proof validation, and
#      escalation scanning run here.
# HOW: Runs on every PR. Posts impact analysis as PR comment.
#      Validates PR has required proof section. Runs escalation scanner.
#
# AUTHOR: Claude Opus 4.6
# LAST UPDATED: 2026-03-01
##

name: Framework Gates

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: framework-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  impact-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run impact graph
        id: impact
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          OUTPUT=$(bash scripts/impact-graph.sh --base "$BASE_REF" 2>&1 || true)
          echo "$OUTPUT"
          echo "$OUTPUT" > /tmp/impact-report.txt

      - name: Post impact analysis to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '';
            try {
              report = fs.readFileSync('/tmp/impact-report.txt', 'utf8');
            } catch (e) {
              report = 'Impact analysis did not produce output.';
            }

            const body = `## Change Impact Analysis\n\n\`\`\`\n${report}\n\`\`\`\n\n---\n*Generated by Framework Gates workflow*`;

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.data.find(c =>
              c.body.includes('Change Impact Analysis') &&
              c.user.type === 'Bot'
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

  proof-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate PR has proof section
        id: proof
        env:
          EVENT_PATH: ${{ github.event_path }}
        run: |
          if [ -z "${GITHUB_EVENT_PATH:-}" ]; then
            echo "Not a GitHub Actions run — skipping"
            exit 0
          fi

          PR_BODY=$(python3 -c "
          import json, os
          try:
              path = os.environ.get('GITHUB_EVENT_PATH', '')
              with open(path) as f:
                  event = json.load(f)
              body = event.get('pull_request', {}).get('body', '') or ''
              print(body)
          except Exception:
              print('')
          " 2>/dev/null || true)

          if ! echo "$PR_BODY" | grep -qi "^##[[:space:]]*Proof"; then
            echo "❌ Missing ## Proof section in PR description"
            echo "   Every PR must include execution evidence (test output, curl, screenshot)"
            exit 1
          fi

          PROOF_CONTENT=$(echo "$PR_BODY" | sed -n '/^##[[:space:]]*Proof/,/^##/p' | grep -v "^##" | grep -v "^<!--" | grep -v "^$" | head -5)
          if [ -z "$PROOF_CONTENT" ]; then
            echo "⚠️  ## Proof section exists but appears empty"
            echo "   Add actual execution evidence before merging"
            exit 0
          fi

          echo "✅ Proof section present with content"

      - name: Capture proof validation failure
        if: failure() && steps.proof.outcome == 'failure'
        run: |
          bash scripts/capture-feedback.sh \
            --type ci-failure \
            --source ci \
            --summary "PR missing proof section — no execution evidence" \
            --bucket stub-shipped \
            --automatable true \
            --automatable-as pre-commit-hook || true

  escalation-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run escalation scanner
        run: bash scripts/scan-escalations.sh
