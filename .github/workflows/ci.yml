##
# FILE PURPOSE: CI quality gates — single orchestrator for all apps
#
# WHY: Every tool plugs into GitHub Actions. No tool-to-tool wiring.
#      One workflow runs quality gates across the entire monorepo.
# HOW: Turborepo runs type-check, lint, test across all workspaces.
#      Architecture and doc checks run universally.
#
# AUTHOR: Claude Opus 4.6
# LAST UPDATED: 2026-02-28
##

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─── Universal quality gates ────────────────────────────────────
  quality-gates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # Zerox postinstall runs apt-get for Ghostscript/LibreOffice/GraphicsMagick.
      # needrestart prompts block non-interactive installs, so remove it first.
      - name: Disable needrestart for zerox postinstall
        run: sudo apt-get remove -y needrestart > /dev/null 2>&1 || true

      - run: npm ci --legacy-peer-deps

      # Dependency vulnerability scan (SECURITY.md §Dependency Policy)
      # Blocking gate — unfixable vulns must be in .audit-allowlist.json with expiry
      - name: npm audit (with allowlist)
        run: node scripts/audit-with-allowlist.js

      # TypeScript + ESLint + Tests via Turborepo
      - name: Type check
        run: npx turbo run type-check

      - name: Lint
        run: npx turbo run lint

      - name: Test
        run: npx turbo run test

      # Architecture limits (file size, function size)
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check architecture limits
        run: python scripts/check_architecture_limits.py

      # Doc freshness
      - name: Check doc freshness
        run: bash scripts/check_doc_freshness.sh --base ${{ github.event.pull_request.base.ref || 'main' }}

      # Rate limit enforcement (§18)
      - name: Check rate limiting
        run: bash scripts/check-rate-limit.sh

      # Destructive SQL detection
      - name: Check destructive SQL
        run: bash scripts/check-destructive-sql.sh

      # Guardrail enforcement (§21)
      - name: Check guardrail usage
        run: bash scripts/check-guardrail-usage.sh

      # API contracts documentation check
      - name: Check API contracts
        run: bash scripts/check-api-contracts.sh

      # PR template enforcement (PR-only)
      - name: Check PR template
        id: pr-template
        if: github.event_name == 'pull_request'
        run: bash scripts/check-pr-template.sh

      - name: Capture PR template failure
        if: failure() && steps.pr-template.outcome == 'failure'
        run: |
          bash scripts/capture-feedback.sh \
            --type ci-failure \
            --source ci \
            --summary "PR template missing required sections" \
            --bucket config-mismatch \
            --automatable true \
            --automatable-as pre-commit-hook || true

      # Preview deploy verification (PR-only, UI changes)
      - name: Check preview deploy
        if: github.event_name == 'pull_request'
        run: bash scripts/check-preview-deploy.sh
        env:
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}

      # Hallucination detection
      - name: Hallucination check
        id: hallucination
        if: github.event_name == 'pull_request'
        env:
          BASE_REF: ${{ github.event.pull_request.base.ref || 'main' }}
        run: bash scripts/hallucination_check.sh --base "$BASE_REF"

      - name: Capture hallucination failure
        if: failure() && steps.hallucination.outcome == 'failure'
        run: |
          bash scripts/capture-feedback.sh \
            --type ci-failure \
            --source ci \
            --summary "Hallucination check failed — fabricated data or debug artifacts" \
            --bucket hallucinated-import \
            --automatable true \
            --automatable-as eslint-rule || true

  # ─── Python checks ───────────────────────────────────────────────
  python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ruff
        run: pip install ruff

      - name: Lint Python
        run: ruff check packages/ apps/ --config pyproject.toml

  # ─── API contract tests (real Postgres + Redis) ──────────────────────
  api-contract:
    runs-on: ubuntu-latest
    needs: quality-gates
    services:
      postgres:
        image: pgvector/pgvector:pg17
        ports: ['5432:5432']
        env:
          POSTGRES_USER: playbook_test
          POSTGRES_PASSWORD: test_password_ci
          POSTGRES_DB: playbook_test
        options: >-
          --health-cmd "pg_isready -U playbook_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports: ['6379:6379']
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://playbook_test:test_password_ci@localhost:5432/playbook_test
      REDIS_URL: redis://localhost:6379
      NODE_ENV: test
      ADMIN_API_KEY: test-admin-key-for-ci
      AUTH_MODE: strict
      API_KEYS: test-api-key-for-ci
      API_INTERNAL_KEY: test-internal-key-for-ci
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Disable needrestart for zerox postinstall
        run: sudo apt-get remove -y needrestart > /dev/null 2>&1 || true

      - run: npm ci --legacy-peer-deps

      - name: Enable pgvector extension
        run: PGPASSWORD=test_password_ci psql -h localhost -U playbook_test -d playbook_test -c "CREATE EXTENSION IF NOT EXISTS vector;"

      - name: Apply database schema
        run: cd apps/api && npx drizzle-kit push
        env:
          DATABASE_URL: postgresql://playbook_test:test_password_ci@localhost:5432/playbook_test

      - name: Build API and dependencies
        run: npx turbo run build --filter=@playbook/api...

      - name: Start API server
        run: node apps/api/dist/server.js &
        env:
          PORT: '3002'

      - name: Wait for API health
        run: |
          DELAY=1
          for i in $(seq 1 60); do
            if curl -sf http://localhost:3002/api/health > /dev/null 2>&1; then
              echo "API healthy after ${i}s"
              exit 0
            fi
            sleep $DELAY
            DELAY=$(( DELAY < 4 ? DELAY * 2 : 4 ))
          done
          echo "::error::API failed to start within 60s"
          curl -sf http://localhost:3002/api/health || true
          exit 1

      - name: Run contract tests
        run: npm run test:contract
        env:
          E2E_API_URL: http://localhost:3002
          TEST_API_KEY: test-api-key-for-ci
          TEST_ADMIN_KEY: test-admin-key-for-ci

      # ─── Full-stack E2E (Playwright + production-built web + admin) ───
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build web + admin for E2E
        run: npx turbo run build --filter=@playbook/web --filter=@playbook/admin
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3002

      - name: Start web production server (port 3000)
        run: npx next start apps/web --port 3000 &
        env:
          PORT: '3000'
          NEXT_PUBLIC_API_URL: http://localhost:3002

      - name: Start admin production server (port 3001)
        run: npx next start apps/admin --port 3001 &
        env:
          PORT: '3001'
          NEXT_PUBLIC_API_URL: http://localhost:3002

      - name: Wait for web + admin servers
        run: |
          DELAY=1
          for i in $(seq 1 120); do
            WEB=$(curl -sf http://localhost:3000 > /dev/null 2>&1 && echo ok || echo waiting)
            ADMIN=$(curl -sf http://localhost:3001 > /dev/null 2>&1 && echo ok || echo waiting)
            if [ "$WEB" = "ok" ] && [ "$ADMIN" = "ok" ]; then
              echo "Web + Admin servers healthy after ${i}s"
              exit 0
            fi
            echo "  attempt $i: web=$WEB admin=$ADMIN (backoff=${DELAY}s)"
            sleep $DELAY
            DELAY=$(( DELAY < 8 ? DELAY * 2 : 8 ))
          done
          echo "::error::Servers failed to start within 120s"
          curl -sf http://localhost:3000 || echo "web unreachable"
          curl -sf http://localhost:3001 || echo "admin unreachable"
          exit 1

      - name: Run fullstack E2E tests
        run: npx playwright test --config=playwright.e2e.config.ts

      - name: Upload fullstack E2E report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fullstack-e2e-report
          path: playwright-report/
          retention-days: 14

  # ─── E2E smoke tests (Playwright) ─────────────────────────────────
  e2e:
    runs-on: ubuntu-latest
    needs: quality-gates
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Disable needrestart for zerox postinstall
        run: sudo apt-get remove -y needrestart > /dev/null 2>&1 || true

      - run: npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build apps
        run: npx turbo run build

      - name: Run E2E tests
        run: npx playwright test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

  # ─── SAST + Secret scanning (blocking gates) ─────────────────────
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: GitGuardian scan
        if: env.GITGUARDIAN_API_KEY != ''
        uses: GitGuardian/ggshield-action@v1
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Semgrep
        run: pip install semgrep

      - name: Semgrep SAST scan
        run: semgrep scan --config=auto --error --severity ERROR apps/ packages/ services/
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
