name: Multi-LLM Review & Hallucination Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: llm-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  detect-and-report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect maker LLM from branch/commits
        id: detect
        run: |
          BRANCH="${{ github.head_ref || github.ref_name }}"
          COMMITS=$(git log --format="%s %b" origin/${{ github.base_ref }}..HEAD 2>/dev/null || echo "")

          MAKER="unknown"
          if echo "$BRANCH" | grep -qi "claude"; then MAKER="claude"
          elif echo "$BRANCH" | grep -qi "codex"; then MAKER="codex"
          elif echo "$BRANCH" | grep -qi "gemini"; then MAKER="gemini"
          elif echo "$BRANCH" | grep -qi "cursor"; then MAKER="cursor"
          elif echo "$COMMITS" | grep -qi "Co-Authored-By:.*Claude"; then MAKER="claude"
          elif echo "$COMMITS" | grep -qi "Co-Authored-By:.*Codex"; then MAKER="codex"
          elif echo "$COMMITS" | grep -qi "Generated by Cursor"; then MAKER="cursor"
          fi

          case "$MAKER" in
            claude) REVIEWER="codex" ;;
            codex)  REVIEWER="claude" ;;
            gemini) REVIEWER="claude" ;;
            cursor) REVIEWER="claude" ;;
            *)      REVIEWER="any" ;;
          esac

          echo "maker=$MAKER" >> $GITHUB_OUTPUT
          echo "reviewer=$REVIEWER" >> $GITHUB_OUTPUT
          echo "Maker: $MAKER, Reviewer: $REVIEWER"

      - name: Run hallucination check
        run: |
          bash scripts/hallucination_check.sh \
            --base ${{ github.base_ref }} \
            --output /tmp/hallucination-report.md

      - name: Post review comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const maker = '${{ steps.detect.outputs.maker }}';
            const reviewer = '${{ steps.detect.outputs.reviewer }}';

            let report = '';
            try {
              report = fs.readFileSync('/tmp/hallucination-report.md', 'utf8');
            } catch (e) {
              report = 'Hallucination check did not produce a report.';
            }

            const body = `## Multi-LLM Review Report

            **Maker LLM**: ${maker}
            **Suggested Reviewer**: ${reviewer}

            > Per playbook Section 2: a different LLM should review the maker's work (maker-checker pattern).

            ---

            ${report}

            ---
            *Generated by Multi-LLM Review workflow*`;

            // Find existing comment to update
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.data.find(c =>
              c.body.includes('Multi-LLM Review Report') &&
              c.user.type === 'Bot'
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }
