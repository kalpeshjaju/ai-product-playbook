# Promptfoo Eval Configuration
# Docs: https://promptfoo.dev/docs/configuration/reference
#
# WHY: Automated prompt regression testing against LiteLLM proxy.
#      Catches quality regressions before they reach production.
#      CI workflow (promptfoo-eval.yml) gates on 90% pass rate.
#
# HOW: `npx promptfoo eval` from this directory, then `npx promptfoo view`.
#
# PREREQS: LiteLLM proxy running (local or Railway) + LITELLM_API_KEY set.
#
# AUTHOR: Claude Opus 4.6
# LAST UPDATED: 2026-03-01

providers:
  - id: openai:chat:claude-sonnet
    config:
      apiBaseUrl: ${LITELLM_PROXY_URL:-http://localhost:4000/v1}
      apiKey: ${LITELLM_API_KEY}
  - id: openai:chat:claude-haiku
    config:
      apiBaseUrl: ${LITELLM_PROXY_URL:-http://localhost:4000/v1}
      apiKey: ${LITELLM_API_KEY}

# ─── Prompt Type 1: JSON Extraction ────────────────────────────────────────
# Tests the model's ability to produce valid, structured JSON output.

prompts:
  - "Extract the key facts from this text as a JSON array: {{input}}"
  - "Classify the following text into exactly one category (technology, business, science, other). Respond with ONLY the category name: {{input}}"
  - "Summarize this in one sentence: {{input}}"

tests:
  # ── JSON Extraction: Case 1 ──
  - vars:
      input: "LiteLLM is an open-source LLM proxy that provides a unified API for multiple LLM providers including OpenAI, Anthropic, and others. It supports load balancing, fallbacks, and cost tracking."
    assert:
      - type: is-json
      - type: contains-any
        value:
          - LiteLLM
          - proxy
          - LLM
      - type: llm-rubric
        value: "Response is valid JSON containing an array of factual statements about the described tool"

  # ── JSON Extraction: Case 2 ──
  - vars:
      input: "PostgreSQL 16 introduced logical replication from standbys, new monitoring views, and improved COPY performance. The release also added the SQL/JSON constructor functions."
    assert:
      - type: is-json
      - type: contains-any
        value:
          - PostgreSQL
          - replication
          - SQL
      - type: llm-rubric
        value: "Response extracts at least 3 distinct factual claims from the input"

  # ── Classification: Case 1 ──
  - vars:
      input: "Apple announced a new M4 chip with improved neural engine performance, targeting AI workloads on-device."
    assert:
      - type: equals
        value: technology
      - type: llm-rubric
        value: "Response is exactly one word — a category name"

  # ── Classification: Case 2 ──
  - vars:
      input: "CRISPR gene editing trials show 90% efficacy in treating sickle cell disease in phase 3 clinical studies."
    assert:
      - type: equals
        value: science
      - type: llm-rubric
        value: "Response is exactly one word — a category name"

  # ── Summarization: Case 1 ──
  - vars:
      input: "The quick brown fox jumps over the lazy dog. This classic pangram contains every letter of the English alphabet at least once. It has been used for over a century to test typewriters, fonts, and keyboards."
    assert:
      - type: contains
        value: fox
      - type: llm-rubric
        value: "Response is a single concise sentence that captures the key point"
      - type: javascript
        value: "output.length < 300"
